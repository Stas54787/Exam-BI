<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }

        .logo {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            border: 2px solid #fc403a1a;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .progress-section {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 14px;
            background: #eee;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(252,64,58,0.08);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fc403a 0%, #130909 100%);
            width: 0%;
            border-radius: 8px;
            transition: width 0.5s;
        }

        .stats h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .stats-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: stretch;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            cursor: default;
            width: 150px;
            height: 80px;
            background-image: linear-gradient(to top, #D8D9DB 0%, #fff 80%, #FDFDFD 100%);
            border-radius: 30px;
            border: 1px solid #8F9092;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #606060;
            text-shadow: 0 1px #fff;
            flex-direction: column;
            padding: 10px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fc403a;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            text-align: center;
            line-height: 1.2;
        }

        .stats-progress-bar {
            width: 100%;
            height: 14px;
            background: #eee;
            border-radius: 8px;
            margin: 18px 0 8px 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(252,64,58,0.08);
        }

        .stats-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fc403a 0%, #130909 100%);
            width: 0%;
            border-radius: 8px;
            transition: width 0.5s;
        }

        .exam-section {
            display: none;
        }

        .question-card {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .question-type {
            color: #666;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .question-text {
            color: #333;
            font-size: 1.2rem;
            line-height: 1.6;
            font-weight: 500;
        }

        .evaluator-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .evaluator-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .evaluation-result {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .result-correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .evaluation-buttons {
            display: flex;
            flex-direction: row !important;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .btn-correct {
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            cursor: pointer;
            width: 150px;
            height: 50px;
            background-image: linear-gradient(to top, #90EE90 0%, #98FB98 80%, #F0FFF0 100%);
            border-radius: 30px;
            border: 1px solid #228B22;
            transition: all 0.2s ease;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #006400;
            text-shadow: 0 1px #fff;
        }

        .btn-correct:hover {
            box-shadow: 0 4px 3px 1px #F0FFF0, 0 6px 8px #90EE90, 0 -4px 4px #228B22, 0 -6px 4px #F0FFF0, inset 0 0 3px 3px #90EE90;
        }

        .btn-correct:active {
            box-shadow: 0 4px 3px 1px #F0FFF0, 0 6px 8px #90EE90, 0 -4px 4px #228B22, 0 -6px 4px #F0FFF0, inset 0 0 5px 3px #228B22, inset 0 0 30px #90EE90;
        }

        .btn-correct:focus {
            box-shadow: 0 4px 3px 1px #F0FFF0, 0 6px 8px #90EE90, 0 -4px 4px #228B22, 0 -6px 4px #F0FFF0, inset 0 0 5px 3px #228B22, inset 0 0 30px #90EE90;
        }

        .btn-incorrect {
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            cursor: pointer;
            width: 150px;
            height: 50px;
            background-image: linear-gradient(to top, #FFB6C1 0%, #FFC0CB 80%, #FFF0F5 100%);
            border-radius: 30px;
            border: 1px solid #DC143C;
            transition: all 0.2s ease;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #8B0000;
            text-shadow: 0 1px #fff;
        }

        .btn-incorrect:hover {
            box-shadow: 0 4px 3px 1px #FFF0F5, 0 6px 8px #FFB6C1, 0 -4px 4px #DC143C, 0 -6px 4px #FFF0F5, inset 0 0 3px 3px #FFB6C1;
        }

        .btn-incorrect:active {
            box-shadow: 0 4px 3px 1px #FFF0F5, 0 6px 8px #FFB6C1, 0 -4px 4px #DC143C, 0 -6px 4px #FFF0F5, inset 0 0 5px 3px #DC143C, inset 0 0 30px #FFB6C1;
        }

        .btn-incorrect:focus {
            box-shadow: 0 4px 3px 1px #FFF0F5, 0 6px 8px #FFB6C1, 0 -4px 4px #DC143C, 0 -6px 4px #FFF0F5, inset 0 0 5px 3px #DC143C, inset 0 0 30px #FFB6C1;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .celebration {
            background: #ffffff;
            color: #333;
            border: 2px solid #fc403a;
        }

        .celebration h2 {
            color: #fc403a;
        }

        .score-display {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            color: white;
        }

        .score-numbers {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 10px;
        }

        .stat-item-button {
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            cursor: pointer;
            width: 150px;
            height: 50px;
            background-image: linear-gradient(to top, #D8D9DB 0%, #fff 80%, #FDFDFD 100%);
            border-radius: 30px;
            border: 1px solid #8F9092;
            transition: all 0.2s ease;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #606060;
            text-shadow: 0 1px #fff;
        }

        .stat-item-button:hover {
            box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 3px 3px #CECFD1;
        }

        .stat-item-button:active {
            box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 5px 3px #999, inset 0 0 30px #aaa;
        }

        .stat-item-button:focus {
            box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 5px 3px #999, inset 0 0 30px #aaa;
        }
            .container {
                padding: 20px;
            }
            
            .stats-grid {
                gap: 10px;
            }
            
            .stat-item {
                width: 120px;
                height: 70px;
            }
            
            .stat-number {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .evaluation-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            .stat-item-button {
                width: 120px;
                height: 45px;
                font-size: 12px;
            }
        }

        .start-button {
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            cursor: pointer;
            width: 150px;
            height: 50px;
            background-image: linear-gradient(to top, #D8D9DB 0%, #fff 80%, #FDFDFD 100%);
            border-radius: 30px;
            border: 1px solid #8F9092;
            transition: all 0.2s ease;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #606060;
            text-shadow: 0 1px #fff;
            margin-top: 20px;
        }

        .start-button:hover {
            box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 3px 3px #CECFD1;
        }

        .start-button:active {
            box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 5px 3px #999, inset 0 0 30px #aaa;
        }

        .start-button:focus {
            box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 5px 3px #999, inset 0 0 30px #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://i.postimg.cc/fb8Q8KFX/Whats-App-Image-2025-07-06-at-14-08-31.jpg" alt="Логотип компании" class="logo" />
        <h1>Финальное тестирование по системе BI</h1>

        <div class="stats">
            <h3>Статистика прохождения</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalQuestions">0</div>
                    <div class="stat-label">Вопросов пройдено</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="correctAnswers">0</div>
                    <div class="stat-label">Правильных ответов</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="incorrectAnswers">0</div>
                    <div class="stat-label">Неправильных ответов</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">Прогресс</div>
                </div>
            </div>
        </div>

        <div id="mainScreen">
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button class="stat-item-button" onclick="startExam()">Начать тестирование</button>
            </div>
            <address style="text-align: center; font-size: 0.875rem; color: #666; opacity: 0.8; margin-top: 30px;">
                © 2025 Сизько Станислав
            </address>
        </div>

        <div id="examScreen" class="exam-section">
            <div id="questionContainer"></div>

            <div class="evaluator-section" id="evaluatorSection" style="display: none">
                <div class="evaluator-title">📋 Оценка экзаменатора</div>
                <div class="evaluation-result" id="evaluationResult"></div>
                <div class="evaluation-buttons">
                    <button class="btn btn-correct" onclick="evaluateAnswer(true)">
                        ✅ Правильно
                    </button>
                    <button class="btn btn-incorrect" onclick="evaluateAnswer(false)">
                        ❌ Неправильно
                    </button>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-success" id="completeBtn" onclick="completeTest()" style="display: none" disabled>
                    Завершить тестирование
                </button>
            </div>
        </div>
    </div>

    <script>
        const questions = [
            {
                type: 'Вопрос',
                text: 'Для чего нужна система BI? Объясните.',
            },
            {
                type: 'Вопрос',
                text: 'С чем можно сравнить систему BI? На что похож ее принцип?',
            },
            {
                type: 'Практический',
                text: 'Продемонстрируйте, как попасть в систему BI.',
            },
            {
                type: 'Вопрос',
                text: 'Какие бывают подсистемы BI?',
            },
            {
                type: 'Практический',
                text: 'Что такое дэшборд? Продемонстрируйте настройку виджетов.',
            },
            {
                type: 'Практический',
                text: 'Что такое сводные отчеты, где они находятся? Продемонстрируйте.',
            },
            {
                type: 'Практический',
                text: 'Как настроить сводку под себя?',
            },
            {
                type: 'Практический',
                text: 'Что такое этажи инсайт? Как попасть в этажи инсайт? Продемонстрируйте.',
            },
        ];

        // Конфигурация Google Sheets
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykOf-u3wye3_zEzB8VdFq77Mxk17YPWmlF9cgn6bs5oJLZSlLwnAEitzAHo6M6tJ-C/exec';
        
        let currentQuestionIndex = 0;
        let currentTestAnswered = 0;
        let currentTestCorrect = 0;
        let currentTestIncorrect = 0;
        let testStartTime = null;
        let totalAnswered = parseInt(localStorage.getItem('totalAnswered') || '0');
        let correctAnswers = parseInt(localStorage.getItem('correctAnswers') || '0');
        let incorrectAnswers = parseInt(localStorage.getItem('incorrectAnswers') || '0');
        let isQuestionEvaluated = false;
        let answersLog = JSON.parse(localStorage.getItem('answersLog') || '[]');

        function initializeApp() {
            // Инициализируем статистику с нулевыми значениями для нового теста
            updateStats();
        }

        function updateProgress() {
            // Эта функция больше не нужна, так как прогресс-бар показывается только в вопросах
        }

        function updateStats() {
            const totalQuestionsEl = document.getElementById('totalQuestions');
            const correctAnswersEl = document.getElementById('correctAnswers');
            const incorrectAnswersEl = document.getElementById('incorrectAnswers');
            const successRateEl = document.getElementById('successRate');
            
            // Показываем данные ТЕКУЩЕГО теста, а не общие
            if (totalQuestionsEl) totalQuestionsEl.textContent = currentTestAnswered;
            if (correctAnswersEl) correctAnswersEl.textContent = currentTestCorrect;
            if (incorrectAnswersEl) incorrectAnswersEl.textContent = currentTestIncorrect;
            if (successRateEl) {
                // Прогресс = сколько процентов теста пройдено
                const progressPercent = Math.round((currentTestAnswered / questions.length) * 100);
                successRateEl.textContent = progressPercent + '%';
            }
        }

        function startExam() {
            currentQuestionIndex = 0;
            isQuestionEvaluated = false;
            
            // Сброс счетчиков для текущего теста
            currentTestAnswered = 0;
            currentTestCorrect = 0;
            currentTestIncorrect = 0;
            
            // Запоминаем время начала теста
            testStartTime = new Date();
            
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('examScreen').style.display = 'block';
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showFinalResults();
                return;
            }

            const question = questions[currentQuestionIndex];
            const questionContainer = document.getElementById('questionContainer');
            
            questionContainer.innerHTML = `
                <div class="question-card">
                    <div class="question-type">
                        ${question.type} вопрос ${currentTestAnswered + 1}/${questions.length}
                    </div>
                    <div class="question-text">${question.text}</div>
                    <div class="stats-progress-bar" style="margin-top: 20px;">
                        <div class="stats-progress-fill" style="width: ${Math.round((currentTestAnswered / questions.length) * 100)}%;"></div>
                    </div>
                </div>
            `;

            document.getElementById('evaluatorSection').style.display = 'block';
            document.getElementById('evaluationResult').style.display = 'none';
            
            isQuestionEvaluated = false;
            const completeBtn = document.getElementById('completeBtn');
            completeBtn.disabled = true;
            
            if (currentQuestionIndex < questions.length - 1) {
                completeBtn.style.display = 'none';
            } else {
                completeBtn.style.display = 'inline-block';
                completeBtn.textContent = 'Завершить тестирование';
            }
        }

        function evaluateAnswer(isCorrect) {
            if (isQuestionEvaluated) return;
            
            isQuestionEvaluated = true;
            
            // Увеличиваем счетчики ПОСЛЕ ответа
            currentTestAnswered++;
            totalAnswered++;
            
            const question = questions[currentQuestionIndex];
            answersLog.push({
                question: question.text,
                result: isCorrect ? 'Правильно' : 'Неправильно',
                timestamp: new Date().toISOString(),
            });
            
            localStorage.setItem('answersLog', JSON.stringify(answersLog));
            
            const resultDiv = document.getElementById('evaluationResult');
            if (isCorrect) {
                currentTestCorrect++;
                correctAnswers++;
                resultDiv.textContent = '✅ Ответ засчитан как правильный';
                resultDiv.className = 'evaluation-result result-correct';
            } else {
                currentTestIncorrect++;
                incorrectAnswers++;
                resultDiv.textContent = '❌ Ответ засчитан как неправильный';
                resultDiv.className = 'evaluation-result result-incorrect';
            }
            
            resultDiv.style.display = 'block';
            
            localStorage.setItem('totalAnswered', totalAnswered.toString());
            localStorage.setItem('correctAnswers', correctAnswers.toString());
            localStorage.setItem('incorrectAnswers', incorrectAnswers.toString());
            
            updateStats();
            
            // Обновляем прогресс-бар ПОСЛЕ ответа
            const progressBar = document.querySelector('.stats-progress-fill');
            if (progressBar) {
                progressBar.style.width = Math.round((currentTestAnswered / questions.length) * 100) + '%';
            }
            
            // Автоматически переходим к следующему вопросу или показываем кнопку завершения
            setTimeout(() => {
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                } else {
                    document.getElementById('completeBtn').disabled = false;
                }
            }, 1500);
        }

        function completeTest() {
            if (!isQuestionEvaluated && currentQuestionIndex < questions.length) {
                alert('Пожалуйста, сначала оцените последний ответ');
                return;
            }
            showFinalResults();
        }

        function showFinalResults() {
            const totalQuestions = questions.length;
            const percent = currentTestAnswered > 0 ? Math.round((currentTestCorrect / currentTestAnswered) * 100) : 0;
            
            // Отправляем результаты в Google Sheets
            saveToGoogleSheets();
            
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('examScreen').style.display = 'none';
            
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="question-card celebration" style="margin-top: 40px;">
                    <h2 style="color: #fc403a; margin-bottom: 20px;">🎉 Тестирование завершено!</h2>
                    <div style="font-size: 1.5rem; color: #333; font-weight: 700; margin-bottom: 30px; text-align: center;">
                        Ваш результат: <span style="color: #fc403a;">${percent}%</span>
                    </div>
                    <div class="score-display" style="background: ${percent >= 70 ? '#28a745' : '#dc3545'}; margin: 20px 0;">
                        <h4>Итоговая статистика</h4>
                        <div class="score-numbers">${currentTestCorrect}/${currentTestAnswered} правильных ответов</div>
                    </div>
                    <div style="font-size: 1.1rem; color: #333; margin-bottom: 20px;">
                        Всего вопросов: <b>${currentTestAnswered} из ${totalQuestions}</b><br>
                        Правильных ответов: <b>${currentTestCorrect}</b><br>
                        Неправильных ответов: <b>${currentTestIncorrect}</b><br>
                        Прогресс: <b>${Math.round((currentTestAnswered / totalQuestions) * 100)}%</b>
                    </div>
                    <div style="color: #28a745; font-weight: 600; margin: 10px 0;">
                        ✅ Результаты автоматически сохранены в Google Таблице
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="stat-item-button" onclick="downloadDetailedResults()">📊 Скачать результаты</button>
                        <button class="stat-item-button" onclick="restartTest()">🔄 Пройти заново</button>
                        <button class="stat-item-button" onclick="goToMainScreen()">🏠 На главную</button>
                    </div>
                </div>
            `;
        }

        function downloadDetailedResults() {
            if (answersLog.length === 0) {
                alert('Нет данных для скачивания. Пройдите тест сначала.');
                return;
            }
            
            const csvRows = [['Номер вопроса', 'Формулировка вопроса', 'Результат']];
            
            answersLog.forEach((entry, index) => {
                csvRows.push([
                    index + 1,
                    `"${entry.question.replace(/"/g, '""')}"`,
                    entry.result
                ]);
            });

            const csvContent = csvRows.map(row => row.join(',')).join('\n');
            downloadCSV(csvContent, 'Результаты_тестирования_BI');
        }

        function restartTest() {
            // Сброс всех данных
            localStorage.removeItem('totalAnswered');
            localStorage.removeItem('correctAnswers');
            localStorage.removeItem('incorrectAnswers');
            localStorage.removeItem('answersLog');
            
            // Сброс переменных
            totalAnswered = 0;
            correctAnswers = 0;
            incorrectAnswers = 0;
            currentQuestionIndex = 0;
            isQuestionEvaluated = false;
            answersLog = [];
            
            // Начать тест заново
            startExam();
        }

        function goToMainScreen() {
            // Сброс всех данных
            localStorage.removeItem('totalAnswered');
            localStorage.removeItem('correctAnswers');
            localStorage.removeItem('incorrectAnswers');
            localStorage.removeItem('answersLog');
            
            // Сброс переменных
            totalAnswered = 0;
            correctAnswers = 0;
            incorrectAnswers = 0;
            currentQuestionIndex = 0;
            isQuestionEvaluated = false;
            answersLog = [];
            
            // Перезагрузка страницы для возврата на главную
            location.reload();
        }

        function downloadCSV(csvContent, baseFileName) {
            console.log('Начинаем скачивание файла...');
            
            try {
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                const now = new Date();
                const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
                const fileName = `${baseFileName}_${timestamp}.csv`;

                // Создаем blob
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                
                // Проверяем поддержку File System Access API (для Chrome и новых браузеров)
                if ('showSaveFilePicker' in window) {
                    console.log('Используем File System Access API');
                    
                    window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'CSV files',
                            accept: { 'text/csv': ['.csv'] }
                        }]
                    }).then(async (fileHandle) => {
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        alert('Файл успешно сохранен!');
                    }).catch((error) => {
                        if (error.name !== 'AbortError') {
                            console.log('Пользователь отменил сохранение или ошибка:', error);
                            fallbackDownload();
                        }
                    });
                    return;
                }
                
                // Fallback для других браузеров
                function fallbackDownload() {
                    console.log('Используем стандартный метод скачивания');
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    link.href = url;
                    link.download = fileName;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    alert('Файл загружен в папку "Загрузки"');
                }
                
                fallbackDownload();
                
            } catch (error) {
                console.error('Ошибка при скачивании:', error);
                
                // Последний fallback - показать данные для ручного копирования
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    width: 80%;
                    max-width: 600px;
                    max-height: 80%;
                    overflow: auto;
                `;
                
                modal.innerHTML = `
                    <h3 style="margin-bottom: 15px;">Результаты тестирования</h3>
                    <p style="margin-bottom: 15px;">Скопируйте данные ниже и сохраните в файл .csv:</p>
                    <textarea style="width: 100%; height: 300px; font-family: monospace; padding: 10px;" readonly>${csvContent}</textarea>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #fc403a; color: white; border: none; border-radius: 5px; cursor: pointer;">Закрыть</button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                // Автоматическое выделение текста
                const textarea = modal.querySelector('textarea');
                textarea.focus();
                textarea.select();
            }
        }

        function resetTest() {
            if (confirm('Вы уверены, что хотите сбросить весь прогресс? Все результаты будут удалены.')) {
                localStorage.removeItem('totalAnswered');
                localStorage.removeItem('correctAnswers');
                localStorage.removeItem('incorrectAnswers');
                localStorage.removeItem('answersLog');
                
                // Сброс переменных
                totalAnswered = 0;
                correctAnswers = 0;
                incorrectAnswers = 0;
                currentQuestionIndex = 0;
                isQuestionEvaluated = false;
                answersLog = [];
                
                // Обновление интерфейса
                updateStats();
                updateProgress();
                
                alert('Тест успешно сброшен!');
            }
        }

        function saveToGoogleSheets() {
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'ВСТАВЬТЕ_СЮДА_URL_ВАШЕГО_GOOGLE_APPS_SCRIPT') {
                console.log('Google Apps Script URL не настроен');
                return;
            }

            const testEndTime = new Date();
            const testDuration = Math.round((testEndTime - testStartTime) / 1000); // в секундах
            
            const testData = {
                testInfo: {
                    startTime: testStartTime.toLocaleString('ru-RU'),
                    endTime: testEndTime.toLocaleString('ru-RU'),
                    duration: `${Math.floor(testDuration / 60)}:${(testDuration % 60).toString().padStart(2, '0')}`,
                    totalQuestions: questions.length,
                    answeredQuestions: currentTestAnswered,
                    correctAnswers: currentTestCorrect,
                    incorrectAnswers: currentTestIncorrect,
                    successRate: currentTestAnswered > 0 ? Math.round((currentTestCorrect / currentTestAnswered) * 100) : 0,
                    progress: Math.round((currentTestAnswered / questions.length) * 100)
                },
                answers: answersLog.map((answer, index) => ({
                    questionNumber: index + 1,
                    questionType: questions[index] ? questions[index].type : 'Неизвестно',
                    questionText: answer.question,
                    userAnswer: answer.result,
                    timestamp: new Date(answer.timestamp).toLocaleString('ru-RU')
                }))
            };

            console.log('Отправляем данные в Google Sheets:', testData);
            console.log('URL для отправки:', GOOGLE_SCRIPT_URL);

            // ЕДИНСТВЕННЫЙ РАБОЧИЙ СПОСОБ для локального запуска - через невидимый iframe
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = 'googleSheetSubmit';
            document.body.appendChild(iframe);

            // Создаем форму для отправки POST запроса через iframe
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_SCRIPT_URL;
            form.target = 'googleSheetSubmit'; // Отправляем в iframe
            form.style.display = 'none';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(testData);
            
            form.appendChild(input);
            document.body.appendChild(form);
            
            console.log('Отправляем форму через iframe...');
            form.submit();
            
            // Удаляем форму и iframe через некоторое время
            setTimeout(() => {
                if (document.body.contains(form)) {
                    document.body.removeChild(form);
                }
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
                console.log('✅ Данные отправлены в Google Sheets через форму');
            }, 3000);

            // Показываем пользователю, что данные отправляются
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px;
                border-radius: 5px;
                z-index: 10000;
                font-weight: 600;
            `;
            notification.textContent = '📊 Данные отправляются в Google Таблицу...';
            document.body.appendChild(notification);

            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.textContent = '✅ Данные отправлены в Google Таблицу!';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 2000);
                }
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });
    </script>
</body>
</html>
